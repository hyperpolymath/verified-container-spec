= Trust Store Format
:spec-version: 0.1.0
:status: draft
:media-type: application/vnd.verified-container.trust-store+json

== 1. Overview

A trust store contains public keys and policies for verifying attestation bundles. Both producers and consumers maintain trust stores, which may have overlapping content but are independently managed.

== 2. Media Type

```
application/vnd.verified-container.trust-store+json
```

== 3. Structure

```json
{
  "$schema": "https://verified-container.org/schema/trust-store-v1.json",
  "version": 1,
  "id": "unique-trust-store-id",
  "updated": "2024-12-28T00:00:00Z",
  "keys": { /* keyed by role */ },
  "thresholds": { /* threshold groups */ },
  "logs": { /* transparency log operators */ }
}
```

== 4. Fields

=== 4.1 $schema (RECOMMENDED)

JSON Schema URI for validation.

=== 4.2 version (REQUIRED)

Integer version of this trust store format. Currently `1`.

=== 4.3 id (REQUIRED)

Unique identifier for this trust store. Used for update verification.

=== 4.4 updated (REQUIRED)

ISO 8601 timestamp of last update.

=== 4.5 keys (REQUIRED)

Object mapping roles to arrays of key entries.

```json
{
  "keys": {
    "builders": [ /* keys that sign build attestations */ ],
    "releasers": [ /* keys that sign release attestations */ ],
    "reviewers": [ /* keys that sign review attestations */ ],
    "trust-store-updaters": [ /* keys that sign trust store updates */ ]
  }
}
```

==== 4.5.1 Key Entry Structure

```json
{
  "id": "unique-key-id",
  "algorithm": "ed25519",
  "publicKey": "base64-encoded-public-key",
  "validFrom": "2024-01-01T00:00:00Z",
  "validUntil": "2025-01-01T00:00:00Z",
  "metadata": {
    "owner": "Organization Name",
    "description": "Purpose of this key"
  }
}
```

[cols="1,1,3"]
|===
| Field | Required | Description

| id
| Yes
| Unique identifier. SHOULD be `sha256:<hash-of-public-key>`.

| algorithm
| Yes
| Cryptographic algorithm. MUST be `"ed25519"` for this version.

| publicKey
| Yes
| Base64-encoded public key bytes.

| validFrom
| Yes
| ISO 8601 timestamp when key becomes valid.

| validUntil
| No
| ISO 8601 timestamp when key expires. If absent, key does not expire.

| metadata
| No
| Additional information about the key.
|===

=== 4.6 thresholds (REQUIRED)

Object defining threshold signature groups.

```json
{
  "thresholds": {
    "release-signers": {
      "k": 3,
      "n": 5,
      "algorithm": "frost-ed25519",
      "members": [
        "key-id-alice",
        "key-id-bob",
        "key-id-carol",
        "key-id-david",
        "key-id-eve"
      ]
    }
  }
}
```

[cols="1,1,3"]
|===
| Field | Required | Description

| k
| Yes
| Minimum number of signatures required.

| n
| Yes
| Total number of members in the group.

| algorithm
| Yes
| Threshold signature algorithm. MUST be `"frost-ed25519"`.

| members
| Yes
| Array of key IDs that are members of this group.
|===

=== 4.7 logs (REQUIRED)

Object defining trusted transparency log operators.

```json
{
  "logs": {
    "verified-container-log-eu": {
      "operator": "EU Transparency Operator",
      "publicKey": "base64-encoded-public-key",
      "url": "https://log-eu.verified-container.org",
      "algorithm": "ed25519"
    },
    "verified-container-log-us": {
      "operator": "US Transparency Operator",
      "publicKey": "base64-encoded-public-key",
      "url": "https://log-us.verified-container.org",
      "algorithm": "ed25519"
    }
  }
}
```

== 5. Trust Store Updates

=== 5.1 Update Format

Trust store updates are distributed as signed documents:

```json
{
  "payloadType": "application/vnd.verified-container.trust-store+json",
  "payload": "<base64-encoded-trust-store>",
  "signatures": [
    {
      "keyid": "sha256:...",
      "sig": "<base64-encoded-signature>"
    }
  ]
}
```

=== 5.2 Update Requirements

1. Updates MUST be signed by a key in the `trust-store-updaters` role
2. The `version` field MUST be greater than the current version
3. The `updated` timestamp MUST be later than the current timestamp
4. Key removals SHOULD include a grace period for propagation

=== 5.3 Key Rotation

When rotating keys:

1. Add new key with future `validFrom` date
2. Distribute update
3. Wait for propagation (recommended: 7 days)
4. Begin using new key
5. Set `validUntil` on old key
6. Distribute update
7. After `validUntil` passes, remove old key

== 6. Minimum Requirements

A compliant trust store MUST contain:

* At least 1 key in `builders` role
* At least 1 threshold group in `thresholds`
* At least 3 log operators in `logs` (for 2-of-3 quorum)

== 7. Example

```json
{
  "$schema": "https://verified-container.org/schema/trust-store-v1.json",
  "version": 1,
  "id": "hyperpolymath-trust-store",
  "updated": "2024-12-28T00:00:00Z",
  "keys": {
    "builders": [
      {
        "id": "sha256:abc123...",
        "algorithm": "ed25519",
        "publicKey": "MCowBQYDK2VwAyEA...",
        "validFrom": "2024-01-01T00:00:00Z",
        "metadata": {
          "owner": "Cerro Torre Cooperative",
          "description": "Official build infrastructure"
        }
      }
    ],
    "releasers": [
      {
        "id": "sha256:def456...",
        "algorithm": "ed25519",
        "publicKey": "MCowBQYDK2VwAyEA...",
        "validFrom": "2024-01-01T00:00:00Z",
        "metadata": {
          "owner": "Alice",
          "description": "Release keyholder 1"
        }
      },
      {
        "id": "sha256:ghi789...",
        "algorithm": "ed25519",
        "publicKey": "MCowBQYDK2VwAyEA...",
        "validFrom": "2024-01-01T00:00:00Z",
        "metadata": {
          "owner": "Bob",
          "description": "Release keyholder 2"
        }
      },
      {
        "id": "sha256:jkl012...",
        "algorithm": "ed25519",
        "publicKey": "MCowBQYDK2VwAyEA...",
        "validFrom": "2024-01-01T00:00:00Z",
        "metadata": {
          "owner": "Carol",
          "description": "Release keyholder 3"
        }
      }
    ],
    "trust-store-updaters": [
      {
        "id": "sha256:mno345...",
        "algorithm": "ed25519",
        "publicKey": "MCowBQYDK2VwAyEA...",
        "validFrom": "2024-01-01T00:00:00Z"
      }
    ]
  },
  "thresholds": {
    "release-signers": {
      "k": 2,
      "n": 3,
      "algorithm": "frost-ed25519",
      "members": [
        "sha256:def456...",
        "sha256:ghi789...",
        "sha256:jkl012..."
      ]
    }
  },
  "logs": {
    "verified-container-log-eu": {
      "operator": "EU Transparency Operator",
      "publicKey": "MCowBQYDK2VwAyEA...",
      "url": "https://log-eu.verified-container.org",
      "algorithm": "ed25519"
    },
    "verified-container-log-us": {
      "operator": "US Transparency Operator",
      "publicKey": "MCowBQYDK2VwAyEA...",
      "url": "https://log-us.verified-container.org",
      "algorithm": "ed25519"
    },
    "verified-container-log-ap": {
      "operator": "APAC Transparency Operator",
      "publicKey": "MCowBQYDK2VwAyEA...",
      "url": "https://log-ap.verified-container.org",
      "algorithm": "ed25519"
    }
  }
}
```

== 8. Security Considerations

=== 8.1 Trust Store Distribution

Trust stores SHOULD be distributed via:
* HTTPS with certificate pinning
* Signed Git commits
* Out-of-band verification (checksums on website)

Trust stores SHOULD NOT be fetched from:
* The same registry as the images being verified
* Unauthenticated channels

=== 8.2 Offline Operation

Systems operating offline MUST have a pre-loaded trust store. The `validUntil` fields allow graceful degradation when updates cannot be fetched.

=== 8.3 Compromise Recovery

If a key is compromised:

1. Publish trust store update removing the compromised key
2. Revoke any attestations signed by that key (log revocation entries)
3. Re-sign affected packages with remaining valid keys
4. If threshold group compromised (k keys), rotate entire group

== 9. Changelog

=== 0.1.0 (2024-12-28)
- Initial specification
