{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://verified-container.org/schema/attestation-bundle-v1.json",
  "title": "Verified Container Attestation Bundle",
  "description": "Schema for attestation bundles containing in-toto attestations with transparency log proofs",
  "type": "object",
  "required": ["mediaType", "version", "attestations", "logEntries"],
  "properties": {
    "mediaType": {
      "type": "string",
      "const": "application/vnd.verified-container.bundle+json",
      "description": "Media type identifier for attestation bundles"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Semantic version of the bundle format"
    },
    "attestations": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/dsseEnvelope" },
      "description": "Array of DSSE-wrapped in-toto attestations"
    },
    "logEntries": {
      "type": "array",
      "minItems": 2,
      "items": { "$ref": "#/$defs/logEntry" },
      "description": "Array of transparency log inclusion proofs (minimum 2 from different operators)"
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata about the bundle",
      "properties": {
        "producer": {
          "type": "string",
          "description": "Name of the producing system"
        },
        "producerVersion": {
          "type": "string",
          "description": "Version of the producing system"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Bundle creation timestamp"
        }
      }
    }
  },
  "$defs": {
    "dsseEnvelope": {
      "type": "object",
      "required": ["payloadType", "payload", "signatures"],
      "description": "Dead Simple Signing Envelope (DSSE) structure",
      "properties": {
        "payloadType": {
          "type": "string",
          "description": "Media type of the payload"
        },
        "payload": {
          "type": "string",
          "pattern": "^[A-Za-z0-9+/=]+$",
          "description": "Base64-encoded payload (in-toto statement)"
        },
        "signatures": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/signature" },
          "description": "Array of signatures over the payload"
        }
      }
    },
    "signature": {
      "type": "object",
      "required": ["keyid", "sig"],
      "properties": {
        "keyid": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$|^[a-zA-Z0-9_-]+$",
          "description": "Key identifier (typically sha256 hash of public key)"
        },
        "sig": {
          "type": "string",
          "pattern": "^[A-Za-z0-9+/=]+$",
          "description": "Base64-encoded signature"
        }
      }
    },
    "logEntry": {
      "type": "object",
      "required": ["logId", "logIndex", "integratedTime", "inclusionProof", "signedEntryTimestamp"],
      "properties": {
        "logId": {
          "type": "string",
          "minLength": 1,
          "description": "Identifier of the transparency log operator"
        },
        "logIndex": {
          "type": "integer",
          "minimum": 0,
          "description": "Monotonic index within the log"
        },
        "integratedTime": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when entry was integrated"
        },
        "inclusionProof": {
          "$ref": "#/$defs/inclusionProof",
          "description": "Merkle tree inclusion proof"
        },
        "signedEntryTimestamp": {
          "type": "string",
          "pattern": "^[A-Za-z0-9+/=]+$",
          "description": "Base64-encoded signature over the entry by the log operator"
        }
      }
    },
    "inclusionProof": {
      "type": "object",
      "required": ["logIndex", "rootHash", "treeSize", "hashes"],
      "properties": {
        "logIndex": {
          "type": "integer",
          "minimum": 0,
          "description": "Index of the entry in the Merkle tree"
        },
        "rootHash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$|^sha256:[a-f0-9]{64}$",
          "description": "Root hash of the Merkle tree (hex or prefixed)"
        },
        "treeSize": {
          "type": "integer",
          "minimum": 1,
          "description": "Size of the tree when proof was generated"
        },
        "hashes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$|^sha256:[a-f0-9]{64}$"
          },
          "description": "Array of hashes forming the inclusion proof path"
        }
      }
    }
  }
}
